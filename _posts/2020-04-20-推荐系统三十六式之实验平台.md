---
layout:     post
title:      推荐系统三十六式之
subtitle:   实验平台
date:       2020-04-20
author:     bjmsong
header-img: img/Recommendation System/th.jpg
catalog: true
tags:
    - 推荐系统
---

- **数据驱动的重点是做对比实验，通过对比，让模型、策略、设计等不同创意和智慧结晶新陈代谢，不断迭代更新**
- 互联网实验，需要三个要素
    - 流量：流量就是用户的访问，也是实验的样本来源
    - 参数：参数就是各种组合，也是用户访问后，从触发互联网产品这个大函数，到最后返回结果给用户，中间所走的路径
    - 结果：实验的全过程都有日志记录，通过这些日志才能分析出实验结果，是否成功，是否显著
- 在设计一个实验之初，实验设计人员总是需要考虑下面这些问题
    - 实验的起止时间：这涉及到样本的数量，关系到统计效果的显著性，也涉及能否取出时间因素的影响
    - 实验的流量大小：这也涉及了样本的数量，关系到统计效果的显著性
    - 流量的分配方式：每一个流量在为其选择参数分支时，希望是不带任何偏见的，也就是均匀采样，通常按照 UUID 或者 Cookie 随机取样
    - 流量的分配条件：还有一些实验需要针对某个流量的子集，例如只对重庆地区的用户测试，推荐时要不要把火锅做额外的提升加权
    - **流量如何无偏置**:这是流量分配最大的问题，也是最难的问题。同时只做一个实验时，这个问题不明显，但是要同时做多个实验，那么如何避免前面的实验给后面的实验带来影响，这个影响就是流量偏置，意思是在前面实验的流量分配中，有一种潜在的因素在影响流量分配，这个潜在的因素不易被人察觉，潜在的因素如果会影响实验结果，那么处在这个实验后面获得流量的实验，就很难得到客观的结论。这个无偏置要求，也叫做“正交”
- 以 Google 的实验平台为主要对象，深入浅出地介绍一个重叠实验平台的方方面面



### 重叠实验架构

- 所谓重叠实验，就是一个流量从进入产品服务，到最后返回结果呈现给用户，中间设置了好几个检查站，每个检查站都在测试某些东西，这样同时做多组实验就是重叠实验
- 重叠实验最大的问题是怎么避免流量偏置。为此，需要引入三个概念
    - 域：是流量的一个大的划分，最上层的流量进来时首先是划分域
    - 层：是系统参数的一个子集，一层实验是对一个参数子集的测试
    - 桶：实验组和对照组就在这些桶中
- 层和域可以互相嵌套。意思是对流量划分，例如划分出50%，这50%的流量是一个域，这个域里面有多个实验层，每一个实验层里面还可以继续嵌套域，也就是可以进一步划分这50%的流量。下面这两个图示意了有域划分和没有域划分的两种情况

<ul> 
<li markdown="1">
![]({{site.baseurl}}/img/Recommendation System/36/划分域.png) 
</li> 
</ul> 

- 图中左边是一个三层实验，但是并没有没有划分域。第一层实验要测试 UI 相关，第二层要测试推荐结果，第三层要测试在推荐结果插入广告的结果。三层互不影响
- 图中的右边则添加了域划分，也就是不再是全部流量都参与实验中，而是被分走了一部分到左边域中。剩下的流量和左边的实验一样

<ul> 
<li markdown="1">
![]({{site.baseurl}}/img/Recommendation System/36/桶.png) 
</li> 
</ul> 

- 这是一个划分域的三层实验。每一层分成 5 个桶，一个流量来了，在第一层，有统一的随机分流算法，将 Cookie 或者 UUID 加上第一层 ID，均匀散列成一个整数，再把这个整数对 5 取模，于是一个流量就随机地进入了 5 个桶之一
- 每一个桶均匀得到 20% 的流量。每一个桶里面已经决定好了为你展示什么样的 UI，流量继续往下走。每一个桶的流量接着依然面对随机进入下一层实验的 5 个桶之一，原来每个桶的 20% 流量都被均分成 5 份，每个桶都有 4% 的流量进入到第二层的每个桶
- 这样一来，第二层每个桶实际上得到的依然是总流量的 20%，而且上一层实验带来的影响被均匀地分散在了这一层的每一个桶中，也就是可以认为上一层实验对这一层没有影响。同样的，第三层实验也是这样
- **这就是分层实验最最基本的原理。在这个基础上，增加了域的概念，只是为了更加灵活地配置更多实验** -- 同时进行多组实验



### 统计效果

- 每一个实验需要累计获得多少流量才能得到实验结论呢？
<ul> 
<li markdown="1">
![]({{site.baseurl}}/img/Recommendation System/36/ab实验规模.png) 
</li> 
</ul> 

- s 是实验指标的标准差。θ 是希望检测的敏感度，比如想检测到 2% 的 CTR 变化
- 上面这个公式计算出来的实验规模，表示以 90% 的概率相信结果的显著性，也就是有 90% 的统计功效。



### 对比实验的弊端

- 落入实验组的流量，在实验期间，可能要冒着一定的风险得到不好的用户体验，在实验结束之前，这部分流量以100%的概率面对这不确定性
- 要得得到较高统计功效的话，就需要较长时间的测试，如果急于看到结果全面上线来说有点不能接受
- 下线的实验组如果不被人想起，就不再有机会得到测试

- 可以考虑在实验平台中用 Bandit 算法替代流量划分的方式，通过 Bandit 算法选择不同的参数组合、策略，动态实时地根据用户表现给出选择策略，一定程度上可以避免上面列举的弊端



### 参考资料

- [Overlapping Experiment Infrastructure:More, Better, Faster Experimentation](https://storage.googleapis.com/pub-tools-public-publication-data/pdf/36500.pdf)

