---
layout:     post
title:      流失用户预警
subtitle:   
date:       2020-06-11
author:     bjmsong
header-img: img/Recommendation System/th.jpg
catalog: true
tags:
    - 推荐系统
---

>“根据美国贝恩公司的调查，在商业社会中5％的客户留存率增长意味着公司利润30％的增长，而把产品卖给老客户的概率是卖给新客户的3倍。所以在‘增长黑客’圈内有一句名言：留住已有的用户胜过拓展新的客户，也就是俗称的‘一鸟在手，胜过双鸟在林’。”
>——《增长黑客》


### 目标

- 找出高潜流失用户，用于定向开展运营激活，从而有效控制用户流失风险，提升大盘用户的留存率和活跃度。
- 用户留存和用户流失是一组相对的概念。诸如获得一个新客户的成本是保持一个老客户的5倍等经过众多商业实践总结出来的数据都证明了一个事实——**提升用户留存率，减少用户流失，对于任何一家企业来说都是非常重要。**



### 用户生命周期

- 在用户生命周期管理（CLM）的分析框架下，不同的用户生命周期阶段我们需要考虑不同的问题，制定不同的用户管理策略，不断改善用户体验的同时，实现用户生命周期价值（CLV）的最大化。

<ul> 
<li markdown="1"> 
![]({{site.baseurl}}/img/Recommendation System/churn/用户生命周期.jpeg) 
</li> 
</ul> 



### 详细设计

- 输出结果
    - 用户流失概率
	- 流失用户特征
- 流失用户定义
    - 曾经访问过 & 最近30天内无访问
      - 确定N：当用户在该业务持续沉默天数超过N天后，持续沉默的比例
- 数据分析
    - 活跃用户/流失用户特征分析
- 样本构造
	- Y：T日未流失的用户，T+N日流失，则为1 ，反之则为0
  - 滑动窗口
	- 划分训练集、验证集、测试集
- 构建特征
	- 特征列表
    - 用户基本属性: 公司、部门、职位、机构类型、开通日期、首次账户类型、当前账户类型 
	  - 用户行为：每次访问时长、每次访问页面数、月活跃天数、访问间隔、月搜索使用次数、数据功能使用次数、研报功能使用次数、股票监控使用次数、加自选股票数量、加自选基金数量、构建组合数量
	  - 其它根据【活跃用户/流失用户分析】得到的特征
	  - 从文本数据里面挖掘用户画像，如用户看过的新闻
	  - 从行为or埋点数据里面挖掘其它特征
	- 滚动计算动态特征历史值
	  - 静态特征不需要滚动计算
	- 数据质量校验
	- 特征探索及处理：特征统计/EDA、缺失、异常、相关性
	- 特征变换
	  - 离散特征
	  - WOE
	- **特征构建好后，可以应用于其它的工作**：活跃用户、种子用户的最近邻搜索
- 建模
	- 选择模型
	  - 分类模型
	    - LR
	    - gbdt+lr
	    - fm
	    - dnn
	  - 生存模型
	  	- [Cox比例风险模型](https://mp.weixin.qq.com/s?__biz=Mzg5ODAzMTkyMg==&mid=2247488990&idx=1&sn=9d219002ef475b661e277fdc297f44ca&chksm=c0699d83f71e149543aaa03e3923df659e4da4d5cc79639abfe257dd0631599c6b35c55bca5d&mpshare=1&scene=1&srcid=&sharer_sharetime=1588466679263&sharer_shareid=602b1ccf63ca4ea52755ecd058f6d407&key=fd9df393504e2978da09dc8a00eb84c1356b8317e5374e7663d7ff5a36d4e8c116cf3531ef3ae50435f5e934262c6a2f0335c94ef5ba55db562b48874acffcbbf1d413fa0763fbff4570f458460e785a&ascene=1&uin=MjM1OTMwMzkwMA%3D%3D&devicetype=Windows+7+x64&version=62090070&lang=zh_CN&exportkey=ASFrgDwoGpnZFbC%2BU3iWyl4%3D&pass_ticket=54H5mTkNDcJGloRn%2BiG0HGlOX7G234LqgKoXtxCtXyrN8aQopin%2F3lMzuW3O0nGF)
	- 特征选择
	- 模型训练
	  - 定时自动训练
	- 模型评估
	  - F1
	  - 召回率、准确率
	  - lift
	  - AUC
	- 优化
	- 模型解释
	  - feature importance
	  - "模型解释"blog中的方法应用，如lime
- 部署任务
    - 预测
    - 每天定时更新
- AB测试



### 开发流程：参照“智能核保”的设计

#### 模块设计、OOP设计、API设计    

- 复用已有的工作，不重复造轮子        
  - 参考成熟的框架
  - 整合已有的代码
- 画模块的流程图，依赖关系        
  - Visio
  - UML
- 用包来安排模块
- 为每个包/模块/类/函数写文档字符串        
  - 说明：功能，参数，返回值，异常。。。
  - 把文档转换成HTML格式：Sphinx，Read the Docs
  - 文档要跟代码保持一致
- 函数要解耦，拆成最细粒度，便于测试



#### TDD：先单元测试，再开发    

- 单元测试用例设计：测试数据准备
- unittest：Pycharm已经整合了
- 代码里面多加断言：assert
- 测试各种边界情况



#### 开发代码    

- 写好注释
- 面向对象编程        
  - 把函数打包成对象
  - 对象：子对象+函数+变量
  - 封装、继承、多态
  - 访问权限：public，private，protected
- 通过repr字符串来输出调试信息
- 异常处理，防止程序crash        
  - try/except ，raise Exception
  - 用自编的模块定义根异常
- 用模块级别的代码来配置不同的部署环境：开发、生产        
  - 把环境相关的信息加入配置文件中，实现代码和配置分离
- 建模流程        
  - 先用一个简单的算法，训练集上训练，验证集上调试，测试集上看效果
  - 画learing-curve，看是high bias 还是 high variane，再决定下一步怎么做
  - 误差分析
- 构建虚拟python环境 ，把这套虚拟环境复制到其它地方：requirement.txt
- 包装成一个包，类似sklearn        
  - https://towardsdatascience.com/building-package-for-machine-learning-project-in-python-3fc16f541693
- 代码质量        
  - 整洁度、可读性、可维护性
  - 稳定性、健壮性



#### 调试    

- Pycharm，pdb
- 构造好debug用的数据集合        
  - 中等样本，便于快速出结果，同时能测试到单元测试检查不到的情况
  - 了解数据（时间段，缺失等情况）
  - 先用ide本地debug (效率比远程调试高很多！)
  - 最后全量样本调试



### 参考资料
- https://cloud.tencent.com/developer/article/1352076