---
layout:     post
title:      操作系统原理及Linux实践
subtitle:   
date:       2022-09-05
author:     bjmsong
header-img: 
catalog: true
tags:
    - Computer Science
---
## 1.Introduction
- 操作系统
    - 定义
        - An operating system acts an intermediary between user of a computer and the computer hardware
        - The purpose of an operating system is to provide an environment in which a user can execute programs in a convenient and efficient manner.
        - An operating system is software that manages the computer hardware.
    - 操作系统向用户提供一个容易理解和使用的“计算机”(虚拟的)，用户对这个“计算机”的操作都将被操作系统转成对计算机硬件的操作
    - 功能
        - 用户的角度
            - 提供良好的用户界面
            - 标准的函数库
            - 使得编程更加方便并且不容易出错
        - 系统的角度
            - 管理资源
                - 硬件资源(处理机，存储 器，设备)
                - 信息资源(文件)
            - 解决申请资源时产生的冲突
            - 阻止错误的产生和对计算机不正当的使用
- 计算机系统的组成
    - CPU
    - 硬盘
    - 内存 memory
        - CPU负责将指令(Instruction)从内存(Memory)读入，所以程序必须在内存中才能运行
        - 内存以字节为存储单位，每个字节都有一个地址与之对应。通过load/store指令即可访问指定地址的内存数据
            - load:将内存数据装入寄存器(Register)
            - store:将寄存器数据写入内存
    - IO设备
- 计算机系统体系结构
    - 单处理器系统
    - 多处理器系统
        - 有两个或多个紧密通信的CPU，它们共享计算机总线、时钟、内存和外设等
    - 集群系统
        - 由若干节点(node)通过网络连接在一起，每个节点可为单处理器系统或多处理器系统，节点之间是松耦合(loosely coupled)关系。
- 操作系统结构
    - 单用户单道模式
    - 多道程序设计
        - 单道程序不能让CPU和IO设备始终忙碌，多道程序设计通过安排任务使用得CPU总有一个执行任务，从而提高CPU利用率
    - 分时系统
        - 允许多个用户共享一台计算机

## 2.Operating-system Structures
- 操作系统的服务
    - 为用户
        - USER INTERFACE：GUI,batch,command line
    - 为程序员
        - system call
            - 系统调用提供了访问和使用操作系统所提供的服务的接口
            - 应用程序App的开发人员通过透过API（Windows API / POSIX API / JAVA API）间接访问了系统调用
            - 双重模式(DUAL MODE)：计算机系统有一个特殊的硬件，用于划分系统的运行状态
                - 用户模式(user mode):执行用户代码
                - 内核模式(kernel mode):执行操作系统代码
- 操作系统的构建方式
- GNU/Linux

## 3.Process
### 进程的定义
- 定义
    - 进程是一个程序的一次执行过程
        - 能完成具体的功能
        - 是在某个数据集合上完成的
        - 执行过程是可并发的
    - 进程是资源分配、保护和调度的基本单位
- 程序和进程
    - A program is a passive entity, such as a file containing a list of instructions stored on disk(often called an executable file).
    - A program becomes a process when an executable file is loaded into memory.
    - A process is an active entity, with a program counter specifying the next instruction to execute an a set of associated resources.
- PROGRAM COUNTER
    - 程序计数器是一个CPU中的寄存器，里面存放下一条要执行指令的内存地址
    - 通常，CPU在取完一条指令之后会将PC寄存器的值 加“1”，以计算下条要执行指令的地址
- PROCESS IN MEMORY
    - text:代码
    - data:全局和静态变量数据
    - stack:栈用于存放局部变量、函数返回地址
    - heap:堆用于程序运行时的动态 内存分配
- 并发的进程
    - Concurrency:the fact of two or more events or circumstances happening or existing at the same time.
    - 一个时刻只有一个进程在一个cpu上执行 
    - 并发进程共享CPU
        - 并发进程可能无法一次性执行完毕，会走走停停
        - 不同进程之间交替执行
        - 一个进程在执行过程中可能会被另一个进程替换占有CPU，这个过程称作"进程切换"
### 进程的状态
- 三种基本状态
    - 运行态(Running):此时进程的代码在CPU上运行
    - 就绪态(Ready):进程具备运行条件，等待分配CPU
    - 等待态(Waiting):进程在等待某些事件的发生(比如IO操作结束或是一个信号)
- 进程何时离开CPU
    - 内部事件
        - 进程主动放弃(yield)CPU，进入等待/终止状态。
        - E.g 使用I/O设备，(非)正常结束。
    - 外部事件
        - 进程被剥夺CPU使用权，进入就绪状态。这个动作叫抢占(preempt)。
        - E.g 时间片到达，高优先权进程到达。

## 4.Process Scheduling
### 进程切换
- 并发进程中，一个进程在执行过程中可能会被另一个进程替换占有CPU，这个过程称作“进程切换”
- 如何触发切换：中断
    - 中断是指程序执行过程中
        - 当发生某个事件时，中止CPU上现行程序的运行
        - 引出该事件的处理程序执行
        - 执行完毕返回原程序中断点继续执行
    - 中断源
        - 外中断: 来自处理器之外的硬件中断信号
            - 如时钟中断、键盘中断、外围设备中断
            - 外部中断均是异步中断
        - 内中断(异常 Exception): 来自于处理器内部，指令执行过程中发生的中断，属同步中断
            - 硬件异常:掉电、奇偶校验错误等
            - 程序异常:非法操作、地址越界、断点、除数为0
            - 系统调用
- 模式切换
    - 中断是用户模式(user mode)向内核模式(kernel mode)转换的唯一途径! 系统调用实质上也是一种中断
    - OS提供Load PSW指令装载用户进程返回用户状态
- 切换过程
    - 保存被中断进程的上下文信息(Context)
    - 修改被中断进程的控制信息(如状态等)
    - 将被中断的进程加入相应的状态队列
    - 调度一个新的进程并恢复它的上下文信息
### 进程调度
- 进程的上下文: 支撑一个进程能运行的所有的环境数据
    - PCB(进程控制块)
        - A Process Control Block contains many pieces of information associated with a specific process.
        - 进程的状态
        - 进程编号:pid
        - program counter:下一条执行指令的地址
        - registers: 运行过程中产生的cpu中的值
        - memory limits
        - 。。。
    - stack
    - heap
    - data
    - text
- 进程队列
    - 进程在整个生命周期中会在各个调度队列中迁移，由操作系统的一个调度器(scheduler)来执行
        - 通过调度策略挑选下一个进程
    - 将PCB进行队列的管理
- 进程调度

- 其它参考
https://www.bilibili.com/video/BV1m7411771N/?spm_id_from=333.999.0.0&vd_source=7798c62f92ce545f56fd00d4daf55e26

## 5.Threads
- fork(): 创建一个子进程
    - clone父进程(所有信息)
    - pid不一样
    - fork()后面的代码会执行两遍：并发执行
    - 父子进程的内存空间是独立的
- 线程
    - 同一个进程内部
- 多线程优势
    - 线程比进程更省资源
    - 线程间通信比内存间通信代价要小
### 线程定义
- 一个应用通常需要同时处理很多工作，比如一个Web浏览器，可能需要同时处理文字和图片，这些同时执行的任务可称为 “执行流”，我们不希望它们是顺序执行的。
- 早期，每个执行流都要创建一个进程来实现，但是进程的创建需要消耗大量的时间和资源。
- 现在，和一个应用相关的所有执行任务都 装在一个进程里，这些进程内部的执行任务就是“线程”(Thread)。
- 多线程之间
    - 共享：code、data、files、全局变量
    - 独立拥有：register、stack(局部变量)
- 优点
    - 响应性
    - 资源共享
    - 经济
    - 可伸缩性
- 定义
    - A thread is a basic unit of CPU utilization; it comprises a thread id, a program counter, a register set, and a stack.
    - It shares with other threads belonging to the same process its code section, data section, and other operating-system resources, such as open files and signals.
    - A traditional (or heavyweight) process has a single thread of control. If a process has multiple threads of control, it can perform more than one task at a time.
### 多线程模型
- 多核编程
    - 在多处理器系统中，多核编程机制让应用程序可以 更有效地将自身的多个执行任务(并发的线程)分 散到不同的处理器上运行，以实现并行计算。
- 用户线程ULT(User Level Thread)
    - ULT在user mode下运行，它的管理无需内核支持
- 内核线程KLT(Kernel Level Thread)
    - KLT在kernel mode下运行，由操作系统支持与管理
- M:1模型
    - 多个ULT对应一个KLT
- 1:1模型：当前主流
- M:M模型

## 6.CPU Scheduling 
- 
- 

## 7.

## 8.

## 9.

## 10.

## 11.

## 12.

## 13.

## 14.

## 15.

- 虚拟地址空间
https://www.bilibili.com/video/BV1m7411771N?p=7&vd_source=7798c62f92ce545f56fd00d4daf55e26

## 参考资料
- https://www.bilibili.com/video/BV1bf4y147PZ?spm_id_from=333.337.search-card.all.click
- github.com/youngyt/LinuxOS_Course
- https://gitee.com/anmuxixixi/LinuxOS
- 《Operating Systems: Three Easy Pieces》
    - https://zhuanlan.zhihu.com/p/49286109
    - https://pages.cs.wisc.edu/~remzi/OSTEP/
- b站 操作系统 哈工大李治军
- 向勇（学堂在线）