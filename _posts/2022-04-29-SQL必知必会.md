---
layout:     post
title:      SQL必知必会
subtitle:   
date:       2022-04-30
author:     bjmsong
header-img: 
catalog: true
tags:
    - 数据库
---
## 了解SQL(Structured Query Language)
- SQL是使用最广泛的数据库语言，几乎所有重要的DBMS都支持SQL
- schema：关于数据库和表的布局及特性的信息
- 行：表中的一个记录
- 主键(primary key)：一列(或一组列)，其值能够唯一标识表中每一行
    - 没有主键，更新或删除表中特定行就极为困难，因为你不能 保证操作只涉及相关的行
    - 表中的任何列都可以作为主键，只要它满足以下条件: 
        - 任意两行都不具有相同的主键值;
        - 每一行都必须具有一个主键值(主键列不允许 NULL 值);
        - 主键列中的值不允许修改或更新;
        - 主键值不能重用(如果某行从表中删除，它的主键不能赋给以后的新行)
- 设计SQL的目的是很好地完成一项任务：提供一种从数据库中读写数据的简单有效的方法
- SQL有如下的优点
    - SQL不是某个特定数据库供应商专有的语言。几乎所有重要的DBMS都支持SQL，所以学习此语言使你几乎能与所有数据库打交道。
    - SQL 简单易学。它的语句全都是由有很强描述性的英语单词组成，而 且这些单词的数目不多。
    - SQL 虽然看上去很简单，但实际上是一种强有力的语言，灵活使用其 语言元素，可以进行非常复杂和高级的数据库操作。
- 不区分大小写
- SQL语言定义了这么几种操作数据库的能力：
    - DDL：Data Definition Language
    DDL允许用户定义数据，也就是创建表、删除表、修改表结构这些操作。通常，DDL由数据库管理员执行
    - DML：Data Manipulation Language
    DML为用户提供添加、删除、更新数据的能力，这些是应用程序对数据库的日常操作
    - DQL：Data Query Language
    DQL允许用户查询数据，这也是通常最频繁的数据库日常操作


## 检索
- 限制结果：top，limit，first，offset
- 注释：--，#，/*..*/

## 排序
- 关系数据库设计理论认为，如果不明确 规定排序顺序，则不应该假定检索出的数据的顺序有任何意义
- 在指定一条 ORDER BY 子句时，应该保证它是 SELECT 语句中最后一 条子句
- 通常，ORDER BY 子句中使用的列将是为显示而选择的列。但是，实际上并不一定要这样，用非检索的列排序数据是完全合法的
- 如果想在多个列上进行降序排序，必须对每一列指定 DESC 关键字

## 过滤
- where
- SQL(像多数语言一样)在处理 OR 操作符前，优先处理 AND 操作符，因此要使用圆括号对操作符进行明确分组
- in
- NOT 操作符有且只有一个功能，那就是否定其后所跟的任何条件
- 通配符:用来匹配值的一部分的特殊字符
    - %：任何字符出现任意次数
    - _: 任何字符出现一次
    - []: 指定一个字符集，它必须匹配指定位置(通配符的位置)的一个字符
- like

## 创建计算字段
- 计算字段并不实际存在于数据库表中。计算字段是运行时在 SELECT 语句内创建的
- 别名：as（可选）

## 使用函数处理数据
- 与几乎所有 DBMS 都等同地支持 SQL 语句(如 SELECT)不同，每一个DBMS都有特定的函数。事实上，只有少数几个函数被所有主要的 DBMS 等同地支持
- 虽然所有类型的函数一般都可以在每个 DBMS 中使用，但 各个函数的名称和语法可能极其不同
- 文本处理
    - TRIM，LTRIM，RTRIM
    - 拼接
    - length
    - left
    - lower，upper
- 日期和时间处理
- 数值处理

## 汇总数据
- avg,count,min,max,sum
- count
    - 使用 COUNT(*)对表中行的数目进行计数，不管表列中包含的是空值 (NULL)还是非空值
    - 使用 COUNT(column)对特定列中具有值的行进行计数，忽略NULL值
- 

## 分组数据
- group by
- having
    - WHERE 过滤行，而 HAVING 过滤分组
    - WHERE 在数据分组前进行过滤，HAVING 在数 据分组后进行过滤

## 子查询
- 子查询(subquery)，即嵌套在其他查询中的查询
- 利用子查询进行过滤
- 作为计算字段使用子查询
- 子查询并不总是执行复杂 SELECT 操作的最有效方法
    - 许多 DBMS 处理联结远比处理 子查询快得多

## 联结表
- 关系型数据库：关系表的设计就是要把信息分解成多个表，一类数据一个表。各表通过某些共同的值互相关联
- 可伸缩(scale)：能够适应不断增加的工作量而不失败。设计良好的数据库或应用程序 称为可伸缩性好(scale well)。
- cross join：由没有联结条件的表关系返回的结果为笛卡儿积
- inner join
- self-join
- natural join：排除多次出现，使每一列只返回一次
- outer join：包含了那些在相关表中没有关联行的行
    - 全外联结、左外联结和右外联结

## 组合查询
- 执行多个查询(多条 SELECT 语句)，并将结果作为一个查询结果集返回
- 主要有两种情况需要使用组合查询:
    - 在一个查询中从不同的表返回结构数据;
    - 对一个表执行多个查询，按一个查询返回数据。
- UNION 中的每个查询必须包含相同的列、表达式或聚集函数(不过， 各个列不需要以相同的次序列出)
- UNION 从查询结果集中自动去除了重复的行
- 使用UNION ALL，DBMS不取消重复的行
- 在用 UNION 组合查询时，只 能使用一条 ORDER BY 子句，它必须位于最后一条 SELECT 语句之后

## 插入数据
- 插入有几种方式:
    - 插入完整的行 insert into tablename(col1,col2...) values(val1,val2...)
    - 插入行的一部分 
    - 插入某些查询的结果 insert into tablename1(col1,col2...) select col1,col2... from tablename2 
- 从一个表复制到另一个表
    - select * into table1 from table2
    - 与 INSERT SELECT 将数据添加到一个已经存在的表不同，SELECT INTO 将数据复制到一个新表

## 更新和删除数据
- update tablename set col=val where condition
- delete from tablename where condition
- 使用 UPDATE 或 DELETE 时所遵循的重要原则
    - 除非确实打算更新和删除每一行，否则绝对不要使用不带 WHERE 子句 的 UPDATE 或 DELETE 语句。
    - 保证每个表都有主键，尽可能 像 WHERE 子句那样使用它(可以指定各主键、多个值或值的范围)。
    - 在 UPDATE 或 DELETE 语句使用 WHERE 子句前，应该先用 SELECT 进 行测试，保证它过滤的是正确的记录，以防编写的 WHERE 子句不正确。
    - 使用强制实施引用完整性的数据库，这样 DBMS 将不允许删除其数据与其他表相关联的行。
    - 有的 DBMS 允许数据库管理员施加约束，防止执行不带 WHERE 子句 的 UPDATE 或 DELETE 语句。如果所采用的 DBMS 支持这个特性，应该使用它。

## 创建表
- 利用CREATE TABLE创建表，必须给出下列信息:
    - 新表的名字，在关键字CREATE TABLE之后给出;  表列的名字和定义，用逗号分隔;
    - 有的 DBMS 还要求指定表的位置
- 允许 NULL 值的列也允许在插 入行时不给出该列的值。不允许 NULL 值的列不接受没有列值的行 
- SQL 允许指定默认值，在插入行时如果不给出值，DBMS 将自动采用默认值
- 更新表定义，可以使用 ALTER TABLE 语句
- 使用 ALTER TABLE 时需要考虑的事情。
    - 理想情况下，不要在表中包含数据时对其进行更新。应该在表的设 计过程中充分考虑未来可能的需求，避免今后对表的结构做大 改动。
    - 所有的 DBMS 都允许给现有的表增加列，不过对所增加列的数据类型 (以及 NULL 和 DEFAULT 的使用)有所限制。
    - 许多 DBMS 不允许删除或更改表中的列。
    - 多数 DBMS 允许重新命名表中的列。
    - 许多 DBMS 限制对已经填有数据的列进行更改，对未填有数据的列几乎没有限制。
- 复杂的表结构更改一般需要手动删除过程，它涉及以下步骤:
(1) 用新的列布局创建一个新表;
(2) 使用 INSERT SELECT 语句从旧表复制数据到新表。有必要的话，可以使用转换函数和计算字段;
(3) 检验包含所需数据的新表;
(4) 重命名旧表(如果确定，可以删除它);
(5) 用旧表原来的名字重命名新表;
(6) 根据需要，重新创建触发器、存储过程、索引和外键。
- drop table
- 这些语句必须小心使用，并且应该在备份后使用

## 视图
- 视图是虚拟的表。与包含数据的表不一样，视图只包含使用时动态检索数据的查询
- 视图的一些常见应用
    - 重用SQL语句
    - 简化复杂的 SQL 操作。在编写查询后，可以方便地重用它而不必知道 其基本查询细节
    - 使用表的一部分而不是整个表
    - 保护数据。可以授予用户访问表的特定部分的权限，而不是整个表的访问权限
    - 更改数据格式和表示。视图可返回与底层表的表示和格式不同的数据
- 创建视图之后，可以用与表基本相同的方式使用它们
- 视图创建和使用的一些最常见的规则和限制
    - 与表一样，视图必须唯一命名
    - 视图可以嵌套
    - 视图不能索引，也不能有关联的触发器或默认值
- 创建视图：CREATE VIEW
- drop view

## 使用存储过程
- 存储过程就是为以后使用而保存的一条 或多条 SQL 语句
- 存储过程的优点：简单、安全、高性能
    - 通过把处理封装在一个易用的单元中，可以简化复杂的操作
    - 由于不要求反复建立一系列处理步骤，因而保证了数据的一致性。如果所有开发人员和应用程序都使用同一存储过程，则所使用的代码都是相同的。这一点的延伸就是防止错误。需要执行的步骤越多，出错的可能性就越大。防止错误保证了数据的一致性。
    - 简化对变动的管理。如果表名、列名或业务逻辑(或别的内容)有变化，那么只需要更改存储过程的代码。使用它的人员甚至不需要知道这些变化。这一点的延伸就是安全性。通过存储过程限制对基础数据的访问，减少了数据讹误(无意识的或别的原因所导致的数据讹误)的机会。
    - 因为存储过程通常以编译过的形式存储，所以 DBMS 处理命令所需的 工作量少，提高了性能。
    - 存在一些只能用在单个请求中的 SQL 元素和特性，存储过程可以使用它们来编写功能更强更灵活的代码。
- 存储过程的缺陷
    - 不同DBMS中的存储过程语法有所不同。事实上，编写真正的可移植存储过程几乎是不可能的。
    - 编写存储过程比编写基本 SQL 语句复杂，需要更高的技能，更丰富的经验。
- 执行存储过程：EXECUTE接受存储过程名和需要传递给它的任何参数
- 创建存储过程：CREATE PROCEDURE

## 管理事务
- 使用事务处理(transaction processing)，通过确保成批的 SQL 操作要么完全执行，要么完全不执行，来维护数据库的完整性。
- 术语
    - 事务(transaction)指一组 SQL 语句;
    - 回退(rollback)指撤销指定 SQL 语句的过程;
    - 提交(commit)指将未存储的 SQL 语句结果写入数据库表;
    - 保留点(savepoint)指事务处理中设置的临时占位符(placeholder)，可以对它发布回退(与回退整个事务处理不同)。
- 控制事务处理

## 使用游标
- 结果集：SQL查询所检索出的结果
- 游标(cursor)是一个存储在 DBMS 服务器上的数据库查询， 它不是一条 SELECT 语句，而是被该语句检索出来的结果集
- 游标主要用于交互式应用，其中用户需要滚动屏幕上的数据，并对数据 进行浏览或做出更改


## 高级SQL
- 约束:管理如何插入或处理数据库数据的规则
    - DBMS 通过在数据库表上施加约束来实施引用完整性。大多数约束是在表定义中定义的
    - 主键
        - 是一种特殊的约束，用来保证一列(或 一组列)中的值是唯一的，而且永不改动
        - 表中任意列只要满足以下条件，都可以用于主键
            - 任意两行的主键值都不相同
            - 每行都具有一个主键值(即列中不允许 NULL 值)
            - 包含主键值的列从不修改或更新
            - 主键值不能重用。如果从表中删除某一行，其主键值不分配给新行
        - 一种定义主键的方法是创建它
    - 外键
        - 外键是表中的一列，其值必须是另一表的主键，是保证引用完整性的极其重要部分。
        - 定义：REFERENCES
    - 唯一约束
        - 用来保证一列(或一组列)中的数据是唯一的。它们类似于主键，但存在以下重要区别：
            - 表可包含多个唯一约束，但每个表只允许一个主键。  唯一约束列可包含 NULL 值。
            - 唯一约束列可修改或更新。
            - 唯一约束列的值可重复使用。
            - 与主键不一样，唯一约束不能用来定义外键。
        - UNIQUE
    - 检查约束
        - 用来保证一列(或一组列)中的数据满足一组指定的条件。检查约束的常见用途有以下几点：
            - 检查最小或最大值。例如，防止 0 个物品的订单(即使 0 是合法的数)。 
            - 指定范围。例如，保证发货日期大于等于今天的日期，但不超过今天起一年后的日期。
            - 只允许特定的值。例如，在性别字段中只允许 M 或 F。
        - CHECK
- 索引
    - 索引用来排序数据以加快搜索和排序操作的速度
    - 可以在一个或多个列上定义索引
    - 在开始创建索引前，应该记住以下内容
        - 索引改善检索操作的性能，但降低了数据插入、修改和删除的性能。在执行这些操作时，DBMS必须动态地更新索引
        - 索引数据可能要占用大量的存储空间
        - 并非所有数据都适合做索引。取值不多的数据(如州)不如具有更多可能值的数据(如姓或名)，能通过索引得到那么多的好处。
        - 索引用于数据过滤和数据排序。如果你经常以某种特定的顺序排序数据，则该数据可能适合做索引。
        - 可以在索引中定义多个列(例如，州加上城市)。这样的索引仅在以州加城市的顺序排序时有用。如果想按城市排序，则这种索引没有用处。
    - CREATE INDEX indexname on tablename (colname)
    - 索引必须唯一命名
- 触发器
    - 触发器是特殊的存储过程,它在特定的数据库活动发生时自动执行
    - 触发器可以与特定表上的 INSERT、UPDATE 和 DELETE 操作(或组合)相关联
    - 触发器内的代码具有以下数据的访问权:
        - INSERT 操作中的所有新数据;
        - UPDATE 操作中的所有新数据和旧数据; 
        - DELETE 操作中删除的数据。
    - 触发器的一些常见用途
        - 保证数据一致。例如，在 INSERT 或 UPDATE 操作中将所有州名转换 为大写。
        - 基于某个表的变动在其他表上执行活动。例如，每当更新或删除一行 时将审计跟踪记录写入某个日志表。
        - 进行额外的验证并根据需要回退数据。例如，保证某个顾客的可用资 金不超限定，如果已经超出，则阻塞插入。
        - 计算计算列的值或更新时间戳。
- 数据库安全
    - 需要保护的操作有：
        - 对数据库管理功能(创建表、更改或删除已存在的表等)的访问; 
        - 对特定数据库或表的访问;
        - 访问的类型(只读、对特定列的访问等);
        - 仅通过视图或存储过程对表进行访问;
        - 创建多层次的安全措施，从而允许多种基于登录的访问和控制; 
        - 限制管理用户账号的能力。

## 关系型数据库
- 数据模型
    - 层次模型
    - 网状模型
    - 关系模型：最终，基于关系模型的关系数据库获得了绝对市场份额
- 


## 参考资料
- 《SQL必知必会》
- 廖雪峰 SQL教程