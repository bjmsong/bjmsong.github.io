---
layout:     post
title:      推荐系统三十六式之
subtitle:   信息流架构
date:       2020-04-18
author:     bjmsong
header-img: img/Recommendation System/th.jpg
catalog: true
tags:
    - 推荐系统
---

### 整体框架

- 如果要搜索 feed 相关的技术文章，应该用`Activity Stream`作为关键词去搜，而不应该只用`feed`搜索

<ul> 
<li markdown="1">
![]({{site.baseurl}}/img/Recommendation System/36/信息流架构.png) 
</li> 
</ul> 

- 模块
    - 日志收集：是所有排序训练的数据来源，要收集的最核心数据就是用户在信息流上产生的行为，用于机器学习更新排序模型
    - 内容发布：用推或者拉的模式把信息流的内容从源头发布到受众端
    - 机器学习：从收集的用户行为日志中训练模型，然后为每一个用户即将收到的信息流内容提供打分服务
    - 信息流服务：为信息流的展示前端提供Rest API
    - 监控：系统的运维标配，保证系统的安全和稳定等



### 数据模型

- **User**
    - 存储：MySQL
- **Activity：内容**
    - 用于表达 Activity 的元素有相应的规范，叫作 `Atom`，你可以参考它并结合产品需求，定义出自己的信息流数据模型来
    - 根据 Atom 规范的定义，一条 Activity 包含的元素有：Time、Actor、Verb、Object、Target、Title、Summary
    - 存储：MySQL、Redis、Cassandra
- **Connection：关系**
    - 存储：mysql



### 动态发布

- Fan-out：动态内容出现在受众的信息流中这个过程



#### “拉”模式（Fan-out-on-load）

- 信息流是在用户登录或者刷新后实时产生的
- 步骤：
  - 获取用户所有连接的终点（如好友、关注对象、兴趣标签）
  2. 获取这些连接终点（关注对象）产生的新内容（Activity）
  3. 按照某个指标排序后输出

<ul> 
<li markdown="1">
![]({{site.baseurl}}/img/Recommendation System/36/拉模式.png) 
</li> 
</ul> 

- 拉模式就是当用户访问时，信息流服务才会去相应的发布源拉取内容到自己的 feed 区来，这是一个阻塞同步的过程。“拉”模式的好处也显而易见，主要有下面两种
    - 实现简单直接：一行 SQL 语句就搞定了
    - 实时：内容产生了，受众只要刷新就看得见
- 拉模式不足
    - 随着连接数的增加，这个操作的复杂度指数级增加
    - 内存中要保留每个人产生的内容
    - 服务很难做到高可用



#### “推”模式（Fan-out-on-write）

- 当一个 Actor 产生了一条 Activity 后，不管受众在不在线，刷没刷新，都会立即将这条内容推送给相应的用户（即和这个 Actor 建立了连接的人），系统为每一个用户单独开辟一个信息流存储区域，用于接收推送的内容。如此一来，当用户登录后，系统只需要读取他自己的信息流即可

<ul> 
<li markdown="1">
![]({{site.baseurl}}/img/Recommendation System/36/推模式.png) 
</li> 
</ul> 

- 推模式的优点：在用户访问自己的信息流时，几乎没有任何复杂的查询操作，所以服务可用性较高
- 推模式的缺点：
  - 大量的写操作：每一个粉丝都要写一次
  - 大量的冗余存储：每一条内容都要存储 N 份（受众数量）
  - 非实时：一条内容产生后，有一定的延迟才会到达受众信息流中
  - 无法解决新用户的信息流产生问题

  
#### 两者结合  
- 既然两者各有优劣，那么实际上就应该将两者结合起来，一种简单的结合方案是全局的：

    - 对于活跃度高的用户，使用推模式，每次他们刷新时不用等待太久，而且内容页相对多一些
    - 对于活跃度没有那么高的用户，使用拉模式，当他们登录时才拉取最新的内容
    - 对于热门的内容生产者，缓存其最新的 N 条内容，用于不同场景下的拉取

- 还有一种结合方案是分用户的，这是 Etsy 的设计方案：

    - 如果受众用户与内容产生用户之间的亲密度高，则优先推送，因为更可能被这个受众所感兴趣
    - 如果受众用户与内容产生用户之间的亲密度低，则推迟推送或者不推送
    - 也不是完全遵循亲密度顺序，而是采用与之相关的概率

- **在中小型的社交网络上，采用纯推模式就够用了，结合的方案可以等业务发展到一定规模后再考虑**

- 对于信息流的产生和存储可以选择的工具有：
    - 用户信息流的存储可以采用`Redis`等 KV 数据库, 使用 uid 作为 key
    - 信息流推送的任务队列可以采用`Celery`等成熟框架


### 信息流排序
- **要避免：没有目标、人工量化**
- 目前信息流采用机器学习排序，以提升类似互动率，停留时长等指标，这已经成为共识
- 通常做成RPC服务，供调用


### 数据管道
- 信息流是一个数据驱动的系统，既要通过历史数据来寻找算法的最优参数，又要通过新的数据验证排序效果
- 这个管道中要使用的相关数据可能有：
    - 互动行为数据，用于记录每一个用户在信息流上的反馈行为；
    - 曝光内容，每一条曝光要有唯一的 ID，曝光的内容仅记录 ID 即可；
    - 互动行为与曝光的映射关系，每条互动数据要对应到一条曝光数据；
    - 用户画像内容，即用户画像，提供用户特征，具体请见我在第 4、5、6 三篇中的内容；
    - 信息流的内容分析数据，提供内容特征，即物品画像
- 对于一个从零开始的信息流，没必要做到在线实时更新排序算法的参数，所以数据的管道可以分成三块：
    - **生成训练样本，可离线**
    - **排序模型训练，可离线**
    - **模型服务化，实时服务**
- 在离线训练优化模型时，关注模型的 AUC 是否有提升，线上 AB 测试时关注具体的产品目标是否有提升，比如互动率等，同时还要根据产品具体形态关注一些辅助指标
- 互动数据相比全部曝光数据，数量会小得多，所以在生成训练数据时需要对负样本（展示了却没有产生互动的样本）进行采样，采样比例也是一个可以优化的参数
    - 固定算法和特征后，在 0.1~0.9 之间遍历对比实验，选择最佳的正负比例即可。经验比例在 2:3 左右，即负样本略大于正样本


### 参考资料
- Activity Feeds Architecture，演示文稿，Esty
    - 本文非常详细地介绍了社交动态信息流的架构设计细节
- Atom Activity Streams 1.0
- TencentRec：Real-time Stream Recommendation in Practice
    - 介绍了腾讯内部的实时推荐系统架构。