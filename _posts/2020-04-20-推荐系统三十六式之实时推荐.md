---
layout:     post
title:      推荐系统三十六式之
subtitle:   实时推荐
date:       2020-04-20
author:     bjmsong
header-img: img/Recommendation System/th.jpg
catalog: true
tags:
    - 推荐系统
---
### 为什么要实时
- 一个连接从建立开始，其连接的强度就开始衰减，直到最后，可能用户不记得自己和那个物品曾经交汇过眼神。
- 用户和物品之间产生的连接，不论轻如点击，还是重如购买，都有推荐的黄金时间。在这个黄金时间，捕捉到用户的兴趣并且给与响应，可能就更容易留住用户。
- 关于到底什么是实时推荐，实际上有三个层次
    - 第一层，“给得及时”，也就是服务的实时响应。这个是最基本的要求，一旦一个推荐系统上线后，在互联网的场景下，没有让用户等个一天一夜的情况，基本上最慢的服务接口整个下来响应时间也超过秒级。达到第一层不能成为实时推荐，但是没达到就是不合格
    - 第二层，“用得及时”，就是特征的实时更新。例如用户刚刚购买了一个新的商品，这个行为事件，立即更新到用户历史行为中，参与到下一次协同过滤推荐结果的召回中。做到这个层次，已经有实时推荐的意思了，常见的效果就是在经过几轮交互之后，用户的首页推荐会有所变化。这一层次的操作影响范围只是当前用户
    - 第三层，“改得及时”，就是模型的实时更新。还是刚才这个例子，用户刚刚购买了一个新的商品，那需要实时地去更新这个商品和所有该用户购买的其他商品之间的相似度，因为这些商品对应的共同购买用户数增加了，商品相似度就是一种推荐模型，所以它的改变影响的是全局推荐

### 架构概览
<ul> 
<li markdown="1">
![]({{site.baseurl}}/img/Recommendation System/36/实时推荐架构.png) 
</li> 
</ul> 

- 前端服务负责和用户之间直接交互，不论是采集用户行为数据，还是给出推荐服务返回结果
- 用户行为数据经过实时的消息队列发布，然后由一个流计算平台消费这些实时数据，一方面清洗后直接入库，另一方面就是参与到实时推荐中，并将实时计算的结果更新到推荐数据库，供推荐服务实时使用


### 实时数据
- 实时的消息队列，Kafka 是非常成熟的选项

<ul> 
<li markdown="1">
![]({{site.baseurl}}/img/Recommendation System/36/kafka.png) 
</li> 
</ul> 

- Kafka 以生产者消费者的模式吞吐数据，这些数据以`主题`的方式组织在一起，每一个主题的数据会被分为多块，消费者各自去消费，互不影响，Kafka 也不会因为某个消费者消费了而删除数据

<ul> 
<li markdown="1">
每一个消费者各自保存状态信息：所消费数据在 Kafka 某个主题某个分块下的偏移位置。也因此任意时刻、任意消费者，只要自己愿意，可以从 Kafka 任意位置开始消费数据，一遍消费，对应的偏移量顺序往前移动。示意图如下
![]({{site.baseurl}}/img/Recommendation System/36/kafka2.png) 
</li> 
</ul> 


### 流计算
- Storm、FLink、Streaming
- 随着 Storm 使用者越来越多，社区越来越繁荣，并且相比 Streaming 的 MiniBatch 模式，Storm 才是真正的流计算。
- Storm 是一个流计算框架，它有以下几个元素
    - Spout，意思是喷嘴，水龙头，接入一个数据流，然后以喷嘴的形式把数据喷洒出去
    - Bolt，意思是螺栓，像是两段水管的连接处，两端可以接入喷嘴，也可以接入另一个螺栓，数据流就进入了下一个处理环节
    - Tuple，意思是元组，就是流在水管中的水
    - Topology，意思是拓扑结构，螺栓和喷嘴，以及之间的数据水管，一起组成了一个有向无环图，这就是一个拓扑结构
- 不用关心水管在哪，水管由 Storm 提供，你只用实现自己需要的水龙头和水管连接的螺栓即可
- 最新的流计算框架 FLink 表现强劲，高吞吐低延迟

### 算法实时化


### 效率提升


