---
layout:     post
title:      深度学习模型部署
subtitle:   
date:       2022-09-20
author:     bjmsong
header-img: 
catalog: true
tags:
    - 模型优化与部署
---
>对推理资源、速度的优化，可以大大拓展AI模型的应用范围：不需要很强大的算力、资源支持也可以部署模型

## 平台
- 服务端：大模型，延迟不敏感
- 移动端/嵌入式/边缘端：小模型，延迟/资源敏感
    - Jetson Nano
    https://github.com/dusty-nv/jetson-inference
    https://www.bilibili.com/video/BV1g44y1J7zS/?spm_id_from=333.337.search-card.all.click&vd_source=7798c62f92ce545f56fd00d4daf55e26
    https://zhuanlan.zhihu.com/p/319292104
    https://aistudio.baidu.com/aistudio/projectdetail/3451173
    https://blog.csdn.net/ting_qifengl/article/details/111246874
    https://www.cxyzjd.com/article/qianbin3200896/108949723
    https://space.bilibili.com/649901866/channel/seriesdetail?sid=214107
    - 树莓派
    https://www.bilibili.com/video/BV1Mv4y1w7Pd/?spm_id_from=333.337.search-card.all.click&vd_source=7798c62f92ce545f56fd00d4daf55e26
    https://qengineering.eu/deep-learning-with-raspberry-pi-and-alternatives.html
    https://blog.csdn.net/ZhaoDongyu_AK47/article/details/106059943
    https://www.bilibili.com/video/BV1RV411x7BN/?spm_id_from=333.337.search-card.all.click&vd_source=7798c62f92ce545f56fd00d4daf55e26

## 方式
- 原始训练框架
    - tf-serving、torchserve
    - 需要安装整个框架
    - 推理性能差
    - 很多冗余功能
    - 内存占用大
- 训练框架的部署引擎
    - tf-lite，TFLite Micro，pytorch-mobile
    - 只支持自己框架训练的模型
    - 支持硬件/OS有限
- 手动模型重构
    - 手写c++，实现计算图，导入权重
    - 有一定技术难度
- 高性能移动端推理引擎
    - 可以直接加载主流深度学习框架的模型文件，无需进行模型转换
    - 只依赖C/C++库，无任何第三方依赖
    - 支持Android/Linux/RTOS/裸板环境
    - API:Python/C等

## 深度学习框架 -> 中间表示 -> 推理引擎
- 中间表示：ONNX，torchscript
    - 只描述网络结构
    - 一些针对网络结构的优化会在中间表示上进行
- 推理引擎：TensorRT，OpenVINO，NCNN
- ONNX(Open Neural Network Exchange)
    - 对不同框架和不同的移动端、边缘设备Runtime进行了标准化，从而降低了模型在不同框架和不同 Runtime 之间转换的成本，现在主流的框架和设备都支持ONNX
    - https://github.com/onnx/onnx
- https://pytorch.org/docs/stable/onnx.html

- https://zhuanlan.zhihu.com/p/498425043
- https://zhuanlan.zhihu.com/p/396781295



## 原始训练框架
### DEPLOYING PYTORCH IN PYTHON VIA A REST API WITH FLASK 
- 不适用于生产环境
    - pytorch模型未经优化，推理较慢
    - flask的WSGI不适合生产环境，需要配合一个高性能的WSGI服务
- https://pytorch.org/tutorials/intermediate/flask_rest_api_tutorial.html
- https://www.bilibili.com/video/BV1Qv41117SR/?spm_id_from=333.337.search-card.all.click&vd_source=7798c62f92ce545f56fd00d4daf55e26
- code: pytorch_in_action/flask


### TORCHSCRIPT
- torchscript本质上是一门特殊语言。它的解释器可以把python代码翻译成一个静态计算图（先不讨论tracing）。这个torchscript模型不需要python即可运行。
    - 当你开始使用torchscript，痛苦就来了：它只支持部分python语法。你的模型在python运行时下原本一切正常，喂给torchscript之后很可能要报错。你必须对照它的语法规则，用等效的表达改写原来的模型。
    - https://www.zhihu.com/question/526092590
- https://pytorch.org/tutorials/beginner/Intro_to_TorchScript_tutorial.html
- code: pytorch_in_action/torchScript
- Evaluation mode
    - Turn off autograd: computation history tracking can be expensive
    - Affects the activity of certain layers with training-only activity
        - Dropout is only active during training
        - BatchNorm only tracks running mean & variance stats during training

    ```python
    model.eval()
    # or
    model.train(False)
    ```

- torchscript
    - a statically-typed subset of Python meant for ML
    - meant for consumption by the Pytorch Just-in-time Compiler(JIT), which performs run-time optimizations on your TorchScript model
    - the perferred method for serializing your trained model and deploy it for production inference
- 
https://www.youtube.com/watch?v=Dk88zv1KYMI&ab_channel=PyTorch
https://blog.csdn.net/dou3516/article/details/82912458
https://github.com/L1aoXingyu/deploy-pytorch-model
https://blog.keras.io/building-a-simple-keras-deep-learning-rest-api.html
https://www.kdnuggets.com/2019/03/deploy-pytorch-model-production.html

### playtorch: for mobile
https://github.com/facebookresearch/playtorch

### torchserve
https://blog.csdn.net/qq_28613337/article/details/110438060

### tf-serving
- https://tensorflow.google.cn/tfx/guide/serving
- https://www.jianshu.com/p/2fffd0e332bc
- [深度学习在美团的工程实践](https://mp.weixin.qq.com/s?__biz=MjM5NjQ5MTI5OA==&mid=2651749161&idx=1&sn=2a34bc1e36fbf259ac63ffe7c94f528b&chksm=bd12a2648a652b72a9027a572a0038d3b8a6448949c53e7aefab617a12811da84efdc88bcd29&mpshare=1&scene=1&srcid=1025pjqMWAMqES7L6Vsb6QTE#rd)

## tf-lite，pytorch-mobile



## 使用React和Flask创建一个完整的机器学习Web应用程序
https://towardsdatascience.com/deploying-a-deep-learning-model-on-mobile-using-tensorflow-and-react-4b594fe04ab
https://python.plainenglish.io/how-to-build-a-predictive-machine-learning-site-with-react-and-python-part-three-frontend-72c063e8716e
https://cloud.tencent.com/developer/article/1449685


https://zhuanlan.zhihu.com/p/477743341
https://zhuanlan.zhihu.com/p/477743341
https://www.zhihu.com/column/c_1497987564452114432
https://mp.weixin.qq.com/s/1xcjOcdZGOOQtSbHa0K20g

- 端侧AI框架加速优化方法
    - 编译优化、缓存优化、多线程、稀疏存储和计算、NEON指令应用、算子优化等
- 系统优化: 指在特定系统平台上，通过Runtime层面性能优化，以提升AI模型的计算效率
    - Op-level的算子优化：FFT Conv2d (7x7, 9x9), Winograd Conv2d (3x3, 5x5) 等；
    - Layer-level的快速算法：Sparse-block net [1] 等；
    - Graph-level的图优化：BN fold、Constant fold、Op fusion和计算图等价变换等；
    - 优化工具与库（手工库、自动编译）：TensorRT (Nvidia), MNN (Alibaba), TVM (Tensor Virtual Machine), Tensor Comprehension (Facebook) 和OpenVINO (Intel) 等；
    

https://blog.csdn.net/lixuejun2008/article/details/103897626
https://zhuanlan.zhihu.com/p/534708101
https://codeantenna.com/a/yyqRoA11ED



## 代码
https://github.com/open-mmlab/mmdeploy
https://github.com/DefTruth/lite.ai.toolkit
https://github.com/jjw-DL/Model_Deployment
https://github.com/CYang828/dl-deploy
https://github.com/PaddlePaddle/FastDeploy
    - https://mp.weixin.qq.com/s/oHZ7l71RwVA_VdoQyeZDag

## Triton
- https://www.zhihu.com/question/480170452/answer/2064096810
- https://openai.com/blog/triton/


## 参考资料
- b站：有三AI
- https://zhuanlan.zhihu.com/p/367042545?utm_campaign=shareopn&utm_medium=social&utm_oi=30249563717632&utm_psn=1565442828280557568&utm_source=wechat_session
https://www.zhihu.com/question/411393222?utm_campaign=Sharon&utm_medium=social&utm_oi=30249563717632&utm_psn=1565442722865135616&utm_source=wechat_session&utm_content=group3_supplementQuestions
https://www.zhihu.com/question/329372124?utm_campaign=shareopn&utm_medium=social&utm_oi=30249563717632&utm_psn=1565442331993591808&utm_source=wechat_session&utm_content=group3_questions
https://www.zhihu.com/question/428800593/answer/1560594742
https://www.zhihu.com/column/c_1497987564452114432
https://www.zhihu.com/column/c_1359601708180529152
https://zhuanlan.zhihu.com/p/82540025