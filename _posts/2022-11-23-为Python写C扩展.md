---
layout:     post
title:      为python写c/c++扩展
subtitle:   
date:       2022-11-23
author:     bjmsong
header-img: 
catalog: true
tags:
    - Python
--- 
## Cython
- Cython是结合了Python和C语言的一种语言，可以简单的认为就是给Python加上了静态类型后的语法，使用者可以维持大部分的Python语法。Cython编写的函数会被自动转译为C和C++代码，因此在Cython中可以插入对于C/C++函数的调用。
- code: pytorch_in_action/cython
1. run_cython.pyx(cython实现python功能), setup.py(指定cython文件)
2. 编译：python setup.py build_ext --inplace
3. main.py中import run_cython
- https://cython.apachecn.org/#/README
- https://cython.readthedocs.io/en/latest/
- https://cython.org/
- https://towardsdatascience.com/use-cython-to-get-more-than-30x-speedup-on-your-python-code-f6cb337919b6
- https://blog.csdn.net/qq_45503700/article/details/108331349?utm_medium=distribute.pc_feed_404.none-task-blog-2~default~BlogCommendFromBaidu~Rate-1-108331349-blog-null.pc_404_mixedpudn&depth_1-utm_source=distribute.pc_feed_404.none-task-blog-2~default~BlogCommendFromBaidu~Rate-1-108331349-blog-null.pc_404_mixedpud
- https://www.bilibili.com/video/BV1NF411i74S/?spm_id_from=333.999.0.0&vd_source=7798c62f92ce545f56fd00d4daf55e26

## Pybind11
### https://pybind11.readthedocs.io/en/stable/index.html#
- https://github.com/charlotteLive/pybind11-Chinese-docs

### https://github.com/tdegeus/pybind11_examples
- 步骤
0. yum install python3-devel
    - 这里对 Python 的依赖是通过 Python3-config --cflags --ldflags --libs 来自动指定
1. git clone https://github.com/pybind/pybind11
2. 写c++实现(例如example.cpp)
3. 写CMakeLists.txt

```
mkdir build
cd build

cmake ..
make

cp example.cpython-36m-x86_64-linux-gnu.so ../
```

4. 构建python虚拟环境,执行python脚本

```python
conda create -n python_3.6 python=3.6
conda activate python_3.6

python ../test.py

conda deactivate
```

### https://www.youtube.com/watch?v=_5T70cAXDJ0&t=32s&ab_channel=JackofSome
- https://gist.github.com/safijari/f7aec85b89906b4b90a8f33039c11263

### https://zhuanlan.zhihu.com/p/444805518
- 《腾讯技术工程：给 Python 算法插上性能的翅膀——pybind11 落地实践》
- Python 官方提供了 Python/C API，但是改造成本非常高，所有的基本类型都必须手动改为 CPython 解释器封装的 binding 类型。由此不难理解，所以Python官网也建议大家使用第三方解决方案
- Cython缺点
    - 需要手动植入 Cython 自带语法（cdef 等），移植和复用成本高
    - 需要增加其他文件，如 setup.py、*.pyx 来让你的 Python 代码最后能够转成性能较高的 C 代码
    - 对于 C++的支持程度存疑
- Boost.Python
    - 最大的缺点是需要依赖庞大的 Boost 库，编译和依赖关系包袱重，只用于解决 Python binding 的话有一种高射炮打蚊子的既视感
- Pybind11
    - 以 Boost.Python 为蓝本，仅提供 Python & C++ binding 功能的精简版，相对于Boost.Python在binary size以及编译速度上有不少优势，对C++支持非常好。
    - Pybind11 通过 C++ 编译时的自省来推断类型信息，来最大程度地减少传统拓展Python模块时繁杂的样板代码，且实现了常见数据类型，如STL数据结构、智能指针、类、函数重载、实例方法等到Python的自动转换，其中函数可以接收和返回自定义数据类型的值、指针或引用。
- 只需要将密集计算的部分代码，改造成 C++代码，并在执行前后分别释放/获取 GIL 锁


### 其它
- https://medium.com/practical-coding/setting-up-a-c-python-project-with-pybind11-and-cmake-8de391494fca
- https://zhuanlan.zhihu.com/p/80884925

