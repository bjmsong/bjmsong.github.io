---
layout:     post
title:      C++工程构建
subtitle:   
date:       2022-10-26
author:     bjmsong
header-img: 
catalog: true
tags:
    - C++
---
## 基础概念
- 源代码（.c）到可执行文件（.exe）
    - 预处理：根据以#开头的命令，修改原始的C程序
    - 编译(compile)：将文本文件翻译成汇编语言程序
        - 编译器只检测程序语法和函数、变量是否被声明
    - 汇编：翻译成机器语言指令，打包成.o文件
    - 链接(link)：把大量的.o文件合并成执行文件
        - 链接器会在所有的.o文件中找寻函数的实现
- 编译器
    - GCC, G++
    https://blog.csdn.net/weixin_38145317/article/details/105225505
    https://blog.csdn.net/m0_68210771/article/details/126599806
        - gcc默认搜索头文件及（静态/动态）库文件的路径
        https://blog.csdn.net/weixin_44698673/article/details/126156344
        http://t.zoukankan.com/youxin-p-5357614.html
        https://blog.csdn.net/weixin_43297891/article/details/126941496
        - gcc升级
        https://blog.csdn.net/qq_41054313/article/details/119453611
            - /lib64/libstdc++.so.6: version GLIBCXX_3.4.20 not found
                - 升级libstdc++.so.6，不要升级GLIBCXX！
                https://zhuanlan.zhihu.com/p/498529973
                https://blog.csdn.net/libaineu2004/article/details/77100132
                https://www.jianshu.com/p/050b2b777b9d
    - Clang(前端)+llvm(后端)
    https://blog.csdn.net/gatieme/article/details/42914393
    - MinGW：GCC的windows版本
    - 不同系统(windows,mac,linux)编译的项目不能兼容：机器码不一样
- 头文件 & 库文件
https://blog.csdn.net/m0_53263647/article/details/126681711
- https://cplusplus.com/doc/tutorial/introduction/

## makefile
- https://seisman.github.io/how-to-write-makefile/index.html
- 定义了一系列的规则来指定，哪些文件需要先编译，哪些文件需要后编译，哪些文件需要重新编译，甚至于进行更复杂的功能操作
- 自动化编译：一旦写好，只需要一个make命令，整个工程完全自动编译，极大的提高了软件开发的效率
- make是一个命令工具，是一个解释makefile中指令的命令工具
    - 执行makefile：make
    - 删除执行文件和所有的中间目标文件：make clean
- makefile文件

```
target ...: prerequisites ...
    command
    ...
    ...
```

- 显式规则
    - prerequisites中如果有一个以上的文件比target文件要新的话，command所定义的命令就会被执行
    - target
        - 可以是一个object file（目标文件），也可以是一个执行文件，还可以是一个标签（label）
        - 必须
    - prerequisites(前置条件)
        - 生成该target所依赖的文件和/或target
        - “目标”是否重新构建的判断标准：只要有一个前置文件不存在，或者有过更新，"目标"就需要重新构建
        - 可选，但是和命令之间必须存在一个
    - command(命令)
        - 该target要执行的命令（任意的shell命令）
        - 表示如何更新目标文件
        - 必须要以 Tab 键开始
        - 可选
- 隐晦规则：简化makefile文件
    - 自动推导：只要make看到一个 .o 文件，它就会自动的把 (同文件名的) .c 文件加在依赖关系中
- 变量定义
- 文件指示
    1. 在一个Makefile中引用另一个Makefile，就像C语言中的include一样
    2. 指根据某些情况指定Makefile中的有效部分，就像C语言中的预编译#if一样
    3. 定义一个多行的命令
- 注释
    - 只有行注释，和UNIX的Shell脚本一样，其注释是用 # 字符

## CMake
- 官方tutorial
    - https://cmake.org/cmake/help/v3.22/guide/tutorial/index.html#guide:CMake%20Tutorial
    - source code
        - cmake源代码/Help/guide/tutorial
        - https://github.com/Kitware/CMake/tree/master/Help/guide/tutorial
- An Introduction to Modern CMake
    - https://cliutils.gitlab.io/modern-cmake/
    - clean, powerful, elegant
- More Modern CMake
    - https://hsf-training.github.io/hsf-training-cmake-webpage/index.html
- IPADS新人培训第二讲：Modern CMake
    - https://www.bilibili.com/video/BV14h41187FZ/?spm_id_from=333.788&vd_source=7798c62f92ce545f56fd00d4daf55e26
    - https://github.com/richardchien/modern-cmake-by-example/tree/8_link_libs_in_same_root
- More Modern CMake - Deniz Bahadir - Meeting C++ 2018
https://www.youtube.com/watch?v=y7ndUhdQuU8&ab_channel=MeetingCpp
    - CMake is a build-system generator，generate input files(例如Makefile) for build-generators(Make,Ninja,Visual Studio,XCode...)
    - cross-platform
        - running on: Linux,Windows,Mac
        - building cross-platform
    - multi language: C/C++,FORTRAN,CUDA....
    - CMake is "modern" since version 3.0(~2014年) 
        - "everything is a self-contained target"
    - build-requirements of a target: everything that is needed to successfully build that target
        - source-files
        - include search-paths
        - pre-processor macros
        - link-dependencies
        - compiler/linker-options
        - compiler/linker-features: e.g. support for C++ standard
    - usgae-requirements of a target: everything that is needed to successfully use that target as a dependency of another target
        - source-files: but normally not
        - include search-paths
        - pre-processor macros
        - link-dependencies
        - compiler/linker-options
        - compiler/linker-features: e.g. support for C++ standard
- Oh No! More Modern CMake - Deniz Bahadir - Meeting C++ 2019
    - https://www.youtube.com/watch?v=y9kSr5enrSk&ab_channel=MeetingCpp
- cmake实践
    - https://cmake.readthedocs.io/en/latest/1.html#
    - cmake版本2.4: traditional cmake
    - https://github.com/fishCoder/CMakePractice/blob/master/cmake%E5%AE%9E%E8%B7%B5.pdf
    - 从零开始详细介绍CMake
        - https://www.bilibili.com/video/BV1vR4y1u77h?spm_id_from=333.337.search-card.all.click&vd_source=7798c62f92ce545f56fd00d4daf55e26
            - make install：将项目生成的库文件、头文件、可执行文件或相关文件等安装到指定位置（系统目录，或发行包目录）
            - 构建静态库和动态库
            - 安装头文件和共享库
            - 使用外部共享库和头文件
- 官方手册，可以查命令用法
https://cmake.org/cmake/help/latest/ 
- 资料汇总
https://github.com/fenneishi/CMake-Summary-of-documentation-chinese-
- https://github.com/onqtam/awesome-cmake/blob/master/README.md
- https://crascit.com/2016/01/31/enhanced-source-file-handling-with-target_sources/#comment-414
- https://zhuanlan.zhihu.com/p/76975231
- https://github.com/ttroy50/cmake-examples
- https://github.com/BrightXiaoHan/CMakeTutorial
- 开源, 免费, 自身不带编译工具，会根据编写的编译规则(CMakeLists.txt),来自动生成目标平台下的原生工程文件(例如Linux下的Makefile)
- 安装&升级Cmake
    - https://osfere.com/linux/how-to-install-latest-cmake-on-centos
    - https://cloud.tencent.com/developer/article/1668873
    - yum install
- 指定gcc路径
    - https://blog.csdn.net/u014397092/article/details/106994423?spm=1001.2101.3001.6650.1&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-106994423-blog-72833327.pc_relevant_3mothn_strategy_recovery&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-106994423-blog-72833327.pc_relevant_3mothn_strategy_recovery&utm_relevant_index=2
- windos环境使用visual studio code通过CMkae构建项目
https://www.bilibili.com/video/BV1rR4y1E7n9?is_story_h5=false&p=1&share_from=ugc&share_medium=android&share_plat=android&share_session_id=e3804bb0-3008-4a55-9dad-4e3d0e50e5f0&share_source=WEIXIN&share_tag=s_i&timestamp=1660873694&unique_k=5ExOdKk
- https://zhuanlan.zhihu.com/p/52874931
- cmake常用变量和常用环境变量
https://juejin.cn/post/6998055558741753893
- https://www.hahack.com/codes/cmake/
- https://www.zhihu.com/question/58949190
- 《professional cmake》

## Bazel
- Google开发的
- redhat系统下安装
    - https://docs.bazel.build/versions/4.0.0/install-redhat.html
- https://bazel.build/start/cpp
- 语法规则
    - https://bazel.build/reference/be/c-cpp
    - build文件
        - cc_binary(): 生成可执行文件，库文件
        - cc_library(): 生成(供内部使用的)库文件
    - https://stackoverflow.com/questions/51689092/playing-with-bazel-c-tutorials-build-does-not-create-use-shared-libraries
- 最佳实践
    - https://bazel.build/docs/bazel-and-cpp
    - https://bazel.build/tutorials/cpp-use-cases
- 概念
    - https://bazel.build/concepts/build-ref
- https://blog.csdn.net/weixin_44970102/article/details/123577855


## 管理C++第三方库
- 方法1：直接下载库的源文件，手动构建
    - CMake：可以指定CMake库的路径
        - https://blog.csdn.net/zhangyk11/article/details/123715194

        ```shell
        mkdir build
        cd build
        cmake ..
        make -j8
        make install
        ```

    - Bazel
        - 易读性更强，但是生态不如cmake
- 方法2：使用包管理工具(apt-get，yum)安装
- 方法3(推荐)：vcpkg，类似于python的pip
    - vcpkg install packagename
    - CMake构建的时候指定vcpkg工具链： -DCMAKE_TOOLCHAIN_FILE=
- 方法4：conan
https://www.bilibili.com/video/BV1wL411u74B/?spm_id_from=333.788.recommend_more_video.-1&vd_source=7798c62f92ce545f56fd00d4daf55e26